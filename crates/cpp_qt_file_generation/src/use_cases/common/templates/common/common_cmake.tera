# Enable coroutines automatically
qcoro_enable_coroutines()

set(LIBRARY_NAME {{ s.global.application_kebab_name }}-common)

option(BUILD_SHARED_LIBS "Build libraries as shared libraries" ON)

if (BUILD_SHARED_LIBS)
    set(LIB_TYPE SHARED)
else ()
    set(LIB_TYPE STATIC)
endif ()

set(SRCS
        database/db_context.h
        database/table_cache.h
        direct_access/repository_factory.h
        direct_access/repository_factory.cpp
        direct_access/converter_registration.h
        direct_access/event_registry.h
        direct_access/mapper_tools.h
        database/junction_table_ops/ordered_one_to_many.h
        database/junction_table_ops/ordered_one_to_many.cpp
        database/junction_table_ops/unordered_many_to_many.h
        database/junction_table_ops/unordered_many_to_many.cpp
        database/junction_table_ops/unordered_one_to_many.h
        database/junction_table_ops/unordered_one_to_many.cpp
        database/junction_table_ops/many_to_one.h
        database/junction_table_ops/many_to_one.cpp
        database/junction_table_ops/one_to_one.h
        database/junction_table_ops/one_to_one.cpp
        database/junction_table_ops/junction_cache.h
        database/snapshot_types.h
        service_locator.cpp
        service_locator.h
        signal_buffer.h
)

set(UNDO_REDO_LIST
        undo_redo/undo_redo_command.h
        undo_redo/undo_redo_command.cpp
        undo_redo/undo_redo_stack.h
        undo_redo/undo_redo_stack.cpp
        undo_redo/undo_redo_manager.h
        undo_redo/undo_redo_manager.cpp
        undo_redo/group_command.h
        undo_redo/group_command.cpp
        undo_redo/query_handler.h
        undo_redo/query_handler.cpp
        undo_redo/undo_redo_system.h
        undo_redo/undo_redo_system.cpp
        undo_redo/group_command_builder.h
        undo_redo/group_command_builder.cpp
)

set(UNIT_OF_WORK_LIST
        unit_of_work/unit_of_work.h
        unit_of_work/uow_base.h
        unit_of_work/uow_macros.h
        unit_of_work/uow_ops.h
)

set(LONG_OPERATION_LIST
        long_operation/i_long_operation.h
        long_operation/long_operation_manager.h
        long_operation/long_operation_manager.cpp
)

qt_add_library(${LIBRARY_NAME} ${LIB_TYPE} ${SRCS} ${UNDO_REDO_LIST} ${UNIT_OF_WORK_LIST} ${LONG_OPERATION_LIST} )

add_subdirectory(entities)
add_subdirectory(direct_access)
add_subdirectory(features)

target_link_libraries(${LIBRARY_NAME} PRIVATE project_options)
target_compile_definitions(${LIBRARY_NAME} PRIVATE
        QT_NO_KEYWORDS
        QT_NO_CAST_TO_ASCII
        QT_NO_CAST_FROM_ASCII
        QT_NO_CAST_FROM_BYTEARRAY
        QT_STRICT_ITERATORS
        QT_USE_QSTRINGBUILDER
        QT_NO_NARROWING_CONVERSIONS_IN_CONNECT
        QT_NO_URL_CAST_FROM_STRING)

include(GenerateExportHeader)
generate_export_header(${LIBRARY_NAME}
        BASE_NAME  {{ s.global.application_snake_name }}_common
)

target_include_directories(${LIBRARY_NAME} PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
        $<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}>
)

target_link_libraries(${LIBRARY_NAME}
        PRIVATE Qt6::Core Qt6::Sql Qt6::Concurrent QCoro::Core
)

 {{ s.global.application_short_name | lower }}_install_target(${LIBRARY_NAME})