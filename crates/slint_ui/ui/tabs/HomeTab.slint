import { Button, VerticalBox, HorizontalBox, ProgressIndicator, AboutSlint } from "std-widgets.slint";
import { ManifestCommands, AppState, CommonTools } from "../globals.slint";
import { Paper, Alert, StyledButton, DocLink } from "../components/misc.slint";


export component HomeTab inherits Rectangle {
    background: #ffffff;

    VerticalLayout {
        padding: 5px;
        spacing: 0px;

        // Title
        Text {
            text: "Qleany";
            font-size: 28px;
            font-weight: 700;
            color: #212529;
        }

        // Subtitle
        Text {
            text: "Welcome to Qleany, a scaffolding generator for C++/Qt6 and Rust.";
            font-size: 16px;
            color: #495057;
        }

        // Error message

        if (AppState.error_message != "") : Alert {
            message: AppState.error_message;
        }

        // Main action buttons in Paper
        Paper {
            with-border: true;
            
            VerticalLayout {
                padding: 16px;
                spacing: 16px;

                HorizontalLayout {
                    spacing: 12px;
                    alignment: start;

                    StyledButton {
                        text: "New Manifest";
                        enabled: !AppState.is_loading;
                        clicked => {
                            if (AppState.manifest_is_saved || !AppState.manifest_is_open) {
                                ManifestCommands.new_manifest();
                            } else {
                                AppState.confirm_dialog_pending_action = "new";
                                AppState.confirm_dialog_message = "You have unsaved changes. Do you want to create a new manifest without saving?";
                                AppState.confirm_dialog_visible = true;
                            }
                        }
                        primary: true;
                    }


                    StyledButton {
                        text: "Open Manifest";
                        enabled: !AppState.is_loading;
                        clicked => {
                            if (AppState.manifest_is_saved) {
                                ManifestCommands.open_manifest();
                            } else {
                                AppState.confirm_dialog_pending_action = "open";
                                AppState.confirm_dialog_message = "You have unsaved changes. Do you want to open another manifest without saving?";
                                AppState.confirm_dialog_visible = true;
                            }
                        }
                        primary: true;
                    }
                    StyledButton {
                        text: "Save Manifest";
                        enabled: AppState.manifest_is_open && !AppState.manifest_is_saved && !AppState.is_loading;
                        clicked => {
                            if (AppState.manifest_path == "") {
                                ManifestCommands.save_manifest_as();
                            } else {
                                ManifestCommands.save_manifest();
                            }
                        }
                        primary: true;
                    }
                    StyledButton {
                        text: "Save Manifest As...";
                        enabled: AppState.manifest_is_open && !AppState.is_loading;
                        clicked => { ManifestCommands.save_manifest_as(); }
                        primary: true;
                    }
                    StyledButton {
                        text: "Close Current Manifest";
                        enabled: AppState.manifest_is_open && !AppState.is_loading;
                        clicked => {
                            if (AppState.manifest_is_saved) {
                                ManifestCommands.close_manifest();
                            } else {
                                AppState.confirm_dialog_pending_action = "close";
                                AppState.confirm_dialog_message = "You have unsaved changes. Do you want to close the manifest without saving?";
                                AppState.confirm_dialog_visible = true;
                            }
                        }
                        primary: false;
                    }
                }

                // Documentation section
                Paper {
                    bg: #f8f9fa;
                    with-border: false;

                    VerticalLayout {
                        padding: 16px;
                        spacing: 12px;

                        Text {
                            text: "Documentation";
                            font-size: 14px;
                            font-weight: 600;
                            color: #212529;
                        }

                        GridLayout {
                            spacing: 8px;
                            Row {
                                DocLink {
                                    label: "Introduction";
                                    url: "https://qleany-docs.pages.dev/introduction.html";
                                    description: "What is Qleany and why use it?";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                                DocLink {
                                    label: "Quick Start — C++/Qt";
                                    url: "https://qleany-docs.pages.dev/quick-start-cpp-qt.html";
                                    description: "Build a complete app step by step";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                                DocLink {
                                    label: "Quick Start — Rust";
                                    url: "https://qleany-docs.pages.dev/quick-start-rust.html";
                                    description: "Build a complete app step by step";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                            }
                            Row {
                                DocLink {
                                    label: "Design Philosophy";
                                    url: "https://qleany-docs.pages.dev/design-philosophy.html";
                                    description: "Why Qleany generates code the way it does";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                                DocLink {
                                    label: "Undo Redo Architecture";
                                    url: "https://qleany-docs.pages.dev/undo-redo-architecture.html";
                                    description: "How to add undo/redo support to your app";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                                DocLink {
                                    label: "How Operations Flow";
                                    url: "https://qleany-docs.pages.dev/how-operations-flow.html";
                                    description: "Button to DB and back data flow, error handling, and more";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                            }
                            Row {
                                DocLink {
                                    label: "Manifest Reference";
                                    url: "https://qleany-docs.pages.dev/manifest-reference.html";
                                    description: "All YAML options explained";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                                DocLink {
                                    label: "QML Integration";
                                    url: "https://qleany-docs.pages.dev/qml-integration.html";
                                    description: "How to use the generated QML components in your app, and UI mocking";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                                DocLink {
                                    label: "Troubleshooting";
                                    url: "https://qleany-docs.pages.dev/troubleshooting.html";
                                    description: "Common issues and fixes";
                                    clicked => { CommonTools.open_url(self.url); }
                                }
                            }
                        }
                    }
                }

                if CommonTools.developer_mode : Paper {
                    bg: #f8f9fa;
                    with-border: true;

                    VerticalLayout {
                        padding: 16px;
                        spacing: 8px;

                        Text {
                            text: "For Testing";
                            font-size: 14px;
                            font-weight: 600;
                            color: #212529;
                        }

                        StyledButton {
                            width: 180px;
                            height: 36px;
                            enabled: !AppState.is_loading;
                            clicked => {
                                if (AppState.manifest_is_saved) {
                                    ManifestCommands.open_qleany_manifest();
                                } else {
                                    AppState.confirm_dialog_pending_action = "open_qleany";
                                    AppState.confirm_dialog_message = "You have unsaved changes. Do you want to open the Qleany manifest without saving?";
                                    AppState.confirm_dialog_visible = true;
                                }
                            }
                            text: "Open Qleany Manifest";
                            primary: false;
                        }
                    }
                }
            }
        }

        HorizontalLayout {
            alignment: center;
            spacing: 24px;

            AboutSlint {
                width: 200px;
            }

            HorizontalLayout {
                spacing: 4px;

                Text {
                    text: "Made by";
                    color: #868e96;
                    font-size: 12px;
                    vertical-alignment: center;
                }

                Text {
                    text: "FernTech";
                    color: #495057;
                    font-size: 12px;
                    font-weight: 500;
                    vertical-alignment: center;
                }
            }
        }

    }
    // Loading overlay
    if AppState.is_loading : Rectangle {
        background: #ffffff80;
        x: 0px;
        y: 0px;
        width: parent.width;
        height: parent.height;

        ProgressIndicator {
            width: 48px;
            height: 48px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            indeterminate: true;
        }
    }
}
