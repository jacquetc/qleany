import { ScrollView, ProgressIndicator, CheckBox, Button, VerticalBox, ListView, LineEdit } from "std-widgets.slint";
import { GenerateCommands, AppState, CRListItem } from "../globals.slint";
import { ListItem, Divider, SectionHeader, StyledButton } from "../components/misc.slint";
import { CheckableReorderableList } from "../components/checkable_reorderable_list.slint";


// Modal overlay
component Modal inherits Rectangle {
    in property <string> title;
    in property <bool> show-modal: false;
    
    visible: show-modal;
    background: #00000060;
    
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 400px;
        height: 200px;
        background: #ffffff;
        border-radius: 8px;
        drop-shadow-blur: 16px;
        drop-shadow-color: #00000040;
        
        VerticalLayout {
            padding: 24px;
            spacing: 16px;
            
            Text {
                text: title;
                font-size: 18px;
                font-weight: 600;
                color: #212529;
            }
            
            @children
        }
    }
}

export component GenerateTab inherits Rectangle {
    background: #ffffff;

    VerticalLayout {
        padding: 40px;
        spacing: 0px;

        // Title
        Text {
            text: "Generate";
            font-size: 32px;
            font-weight: 700;
            color: #212529;
        }

        Rectangle { height: 24px; }

        // Controls row
        HorizontalLayout {
            spacing: 12px;
            alignment: start;
            
            CheckBox {
                text: "in temp/";
                checked <=> AppState.generate_in_temp;
            }
            
            StyledButton {
                text: AppState.generate_is_running ? "Generating..." : "Generate (" + AppState.selected_files_count + ")";
                enabled: !AppState.generate_is_running && AppState.selected_files_count > 0;
                clicked => { GenerateCommands.start_generate(); }
                primary: true;
            }
        }

        Rectangle { height: 24px; }

        // Main 3-column layout
        HorizontalLayout {
            spacing: 0px;

            // Column 1: Groups (25%)
            Rectangle {
                width: 25%;
                background: #f8f9fa;
                border-radius: 8px;
                border-width: 1px;
                border-color: #dee2e6;

                VerticalLayout {
                    SectionHeader {
                        title: "Groups";
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    Rectangle {
                        vertical-stretch: 1;

                        CheckableReorderableList {
                            items: AppState.group_cr_list;
                            reorderable: false;
                            enable-checkbox: true;
                            selected-id: AppState.selected_group_index;
                            selection-changed(id) => {
                                AppState.selected_group_index = id;
                                AppState.group_selected(id);
                            }
                            request-check-change(id, checked) => {
                                AppState.group_check_changed(id, checked);
                            }
                        }
                    }
                }
            }

            // Divider
            Divider {}

            // Column 2: Files (35%)
            Rectangle {
                width: 35%;
                background: #ffffff;
                border-width: 1px;
                border-color: #dee2e6;

                VerticalLayout {
                    // Custom header with filter input
                    Rectangle {
                        height: 48px;
                        background: #f8f9fa;
                        
                        HorizontalLayout {
                            padding: 8px;
                            spacing: 8px;
                            alignment: center;
                            
                            Text {
                                text: "Files";
                                font-size: 14px;
                                font-weight: 600;
                                color: #212529;
                                vertical-alignment: center;
                            }
                            
                            LineEdit {
                                horizontal-stretch: 1;
                                placeholder-text: "Filter...";
                                text <=> AppState.file_filter_text;
                                edited => {
                                    AppState.file_filter_changed(self.text);
                                }
                            }

                            StyledButton {
                                text: "Select All";
                                clicked => { AppState.select_all_files(); }
                            }

                            StyledButton {
                                text: "Unselect All";
                                clicked => { AppState.unselect_all_files(); }
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    Rectangle {
                        vertical-stretch: 1;

                        CheckableReorderableList {
                            items: AppState.file_cr_list;
                            reorderable: false;
                            enable-checkbox: true;
                            selected-id: AppState.selected_file_index;
                            bold-after-slash: true;
                            text-align-right: true;
                            text-prefixes: AppState.file_text_prefixes;
                            text-bolds: AppState.file_text_bolds;
                            selection-changed(id) => {
                                AppState.selected_file_index = id;
                                AppState.file_selected(id);
                            }
                            request-check-change(id, checked) => {
                                AppState.file_check_changed(id, checked);
                            }
                        }
                    }
                }
            }

            // Divider
            Divider {}

            // Column 3: Code Preview (40%)
            Rectangle {
                horizontal-stretch: 1;
                background: #ffffff;
                border-width: 1px;
                border-color: #dee2e6;
                border-radius: 8px;

                VerticalLayout {
                    SectionHeader {
                        title: "Code Preview";
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    ScrollView {
                        viewport-width: text-preview.preferred-width + 32px;
                        viewport-height: text-preview.preferred-height + 32px;

                        Rectangle {
                            background: #f8f9fa;
                            
                            text-preview := Text {
                                x: 16px;
                                y: 16px;
                                text: AppState.selected_file_index >= 0 ? AppState.code_preview : "Select a file to preview";
                                font-size: 14px;
                                font-family: "monospace";
                                color: AppState.selected_file_index >= 0 ? #212529 : #868e96;
                            }
                        }
                    }
                }
            }
        }
    }

    // Progress Modal
    if AppState.generate_is_running : Modal {
        title: "Generating Rust Files";
        show-modal: AppState.generate_is_running;

        ProgressIndicator {
            progress: AppState.generate_progress;
        }

        Text {
            text: AppState.generate_message != "" ? AppState.generate_message : "Processing...";
            font-size: 14px;
            color: #868e96;
        }

        HorizontalLayout {
            alignment: center;
            
            StyledButton {
                text: "Cancel";
                outline: true;
                bg-color: #fa5252;
                enabled: AppState.generate_is_running;
                clicked => { GenerateCommands.cancel_generate(); }
            }
        }
    }
}
