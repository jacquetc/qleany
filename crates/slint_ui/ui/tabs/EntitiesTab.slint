import {
    LineEdit,
    ScrollView,
    ProgressIndicator,
    VerticalBox,
    ListView,
    CheckBox,
    ComboBox,
    TextEdit,
} from "std-widgets.slint";
import {
    AppState,
    EntitiesTabState,
    CRListItem,
    CommonTools,
} from "../globals.slint";
import {
    ListItem,
    Divider,
    SectionHeader,
    FormField,
    StyledLineEdit,
    StyledButton,
    Breadcrumb,
    Paper,
} from "../components/misc.slint";
import {
    CheckableReorderableList,
} from "../components/checkable_reorderable_list.slint";

export component EntitiesTab inherits Rectangle {
    background: #ffffff;

    VerticalLayout {
        padding: 5px;
        spacing: 0px;

        // Title
        Text {
            text: "Entities";
            font-size: 28px;
            font-weight: 700;
            color: #212529;
        }

        HorizontalLayout {
            height: 30px;

            if EntitiesTabState.selected_entity_id >= 0: Rectangle {
                height: 12px;
            }
            if EntitiesTabState.selected_entity_id >= 0: Breadcrumb {
                path: (EntitiesTabState.selected_field_id >= 0) ? [
                    "Entities",
                    EntitiesTabState.selected_entity_name != "" ? EntitiesTabState.selected_entity_name : "Unnamed Entity",
                    EntitiesTabState.selected_field_name != "" ? EntitiesTabState.selected_field_name : "Unnamed Field"
                ] : [
                    "Entities",
                    EntitiesTabState.selected_entity_name != "" ? EntitiesTabState.selected_entity_name : "Unnamed Entity"
                ];
            }

            // Spacer
            Rectangle {
                horizontal-stretch: 1;
            }

            StyledButton {
                text: "Mermaid Diagram";
                enabled: !AppState.is_loading && EntitiesTabState.entity_cr_list.length > 0;
                clicked => {
                    EntitiesTabState.export_to_mermaid_clipboard();
                }
                primary: false;
            }
        }

        Rectangle {
            height: 24px;
        }

        // Main content area - 3 columns
        HorizontalLayout {
            spacing: 0px;

            // Column 1: Entity List
            Paper {
                with-border: true;
                width: 20%;

                VerticalLayout {

                    Rectangle {
                        height: 48px;

                        HorizontalLayout {
                            padding: 12px;
                            alignment: space-between;

                            Text {
                                text: "Entities";
                                font-size: 18px;
                                font-weight: 600;
                                color: #212529;
                                vertical-alignment: center;
                            }

                            Rectangle {
                                width: 28px;
                                height: 28px;
                                background: add-entity-touch.has-hover ? #e7f5ff : transparent;
                                border-radius: 4px;

                                Text {
                                    text: "+";
                                    font-size: 20px;
                                    font-weight: 600;
                                    color: #228be6;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                add-entity-touch := TouchArea {
                                    clicked => {
                                        EntitiesTabState.request_entity_addition();
                                    }
                                }
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    if EntitiesTabState.entity_cr_list.length == 0: Text {
                        font-size: 14px;
                        text: "No entities yet. Click + to create one.";
                        color: #868e96;
                        horizontal-alignment: center;
                    }

                    Rectangle {
                        vertical-stretch: 1;

                        entity_list := CheckableReorderableList {

                            items: EntitiesTabState.entity_cr_list;
                            reorderable: true;
                            enable-checkbox: false;
                            enable-delete: true;
                            selected-id: EntitiesTabState.selected_entity_id;
                            selection-changed(id) => {
                                if (id >= 1) {
                                    EntitiesTabState.entity_selected(id);
                                }
                            }
                            request-reorder(from_index, to_index) => {
                                if (from_index >= 0 && to_index >= 0) {
                                    EntitiesTabState.request_entities_reorder(from_index, to_index)
                                }
                            }
                            request-delete(id) => {
                                if (id >= 1) {
                                    EntitiesTabState.request_entity_deletion(id);
                                }
                            }
                        }
                    }
                }
            }

            // Divider
            Divider { }

            // Column 2: Entity Details + Fields
            Paper {
                horizontal-stretch: 1;
                with-border: true;
                width: 20%;

                VerticalLayout {
                    // Entity Details Section
                    SectionHeader {
                        title: EntitiesTabState.selected_entity_id >= 0 ? EntitiesTabState.selected_entity_name : "Select an entity";
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    if EntitiesTabState.selected_entity_id >= 0: Rectangle {
                        height: 250px;
                        VerticalLayout {
                            padding: 16px;
                            spacing: 8px;
                            entityNameFormField := FormField {
                                label: "Name";
                                required: true;
                                error-message: (EntitiesTabState.selected_entity_id >= 0 && EntitiesTabState.selected_entity_name == "") ? "Entity name is required" : (CommonTools.check_is_pascal_case(EntitiesTabState.selected_entity_name) ? "" : "Entity name must be in PascalCase");

                                StyledLineEdit {
                                    text <=> EntitiesTabState.selected_entity_name;
                                    placeholder: "Enter the entity name (e.g., Person)";
                                    has-error: (EntitiesTabState.selected_entity_id >= 0 && EntitiesTabState.selected_entity_name == "") || !CommonTools.check_is_pascal_case(EntitiesTabState.selected_entity_name);
                                    edited(text) => {
                                        EntitiesTabState.entity_name_changed(text);
                                    }
                                }
                            }

                            CheckBox {
                                text: "Only for heritage";
                                checked <=> EntitiesTabState.selected_entity_only_for_heritage;
                                toggled => {
                                    EntitiesTabState.entity_only_for_heritage_changed(self.checked);
                                }
                            }

                            FormField {
                                label: "Inherits from";

                                inherits-from-combo := ComboBox {
                                    model: EntitiesTabState.inherits_from_options;
                                    current-value <=> EntitiesTabState.selected_entity_inherits_from_value;
                                    selected(value) => {
                                        EntitiesTabState.entity_inherits_from_changed(inherits-from-combo.current-index);
                                    }
                                }
                            }

                            if !EntitiesTabState.selected_entity_only_for_heritage: HorizontalLayout {
                                spacing: 16px;
                                CheckBox {
                                    text: "Single Model";
                                    checked <=> EntitiesTabState.selected_entity_single_model;
                                    toggled => {
                                        EntitiesTabState.entity_single_model_changed(self.checked);
                                    }
                                }

                                CheckBox {
                                    text: "Undoable";
                                    checked <=> EntitiesTabState.selected_entity_undoable;
                                    toggled => {
                                        EntitiesTabState.entity_undoable_changed(self.checked);
                                    }
                                }

                                CheckBox {
                                    text: "Allow direct access";
                                    checked <=> EntitiesTabState.selected_entity_allow_direct_access;
                                    toggled => {
                                        EntitiesTabState.entity_allow_direct_access_changed(self.checked);
                                    }
                                }
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    // Fields Section
                    Rectangle {
                        height: 48px;

                        HorizontalLayout {
                            padding: 12px;
                            alignment: space-between;

                            Text {
                                text: "Fields";
                                font-size: 18px;
                                font-weight: 600;
                                color: #212529;
                                vertical-alignment: center;
                            }

                            Rectangle {
                                width: 28px;
                                height: 28px;
                                background: add-field-touch.has-hover ? #e7f5ff : transparent;
                                border-radius: 4px;

                                Text {
                                    text: "+";
                                    font-size: 20px;
                                    font-weight: 600;
                                    color: #228be6;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                add-field-touch := TouchArea {
                                    clicked => {
                                        EntitiesTabState.request_field_addition();
                                    }
                                }
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    if EntitiesTabState.field_cr_list.length == 0: Text {
                        font-size: 14px;
                        text: "No fields yet. Click + to create one.";
                        color: #868e96;
                        horizontal-alignment: center;
                    }

                    Rectangle {
                        vertical-stretch: 1;

                        field_list := CheckableReorderableList {
                            items: EntitiesTabState.field_cr_list;
                            reorderable: true;
                            enable-checkbox: false;
                            enable-delete: true;
                            selected-id: EntitiesTabState.selected_field_id;
                            selection-changed(id) => {
                                if (id >= 1) {
                                    EntitiesTabState.field_selected(id);
                                }
                            }
                            request-reorder(from_index, to_index) => {
                                if (from_index >= 0 && to_index >= 0) {
                                    EntitiesTabState.request_fields_reorder(from_index, to_index)
                                }
                            }
                            request-delete(id) => {
                                if (id >= 1) {
                                    EntitiesTabState.request_field_deletion(id);
                                }
                            }
                        }
                    }
                }
            }

            // Conditional: Field Details Column (only show when field is selected)
            if EntitiesTabState.selected_field_id >= 0: Divider { }

            if EntitiesTabState.selected_field_id >= 0: Paper {
                horizontal-stretch: 1;
                with-border: true;

                VerticalLayout {
                    SectionHeader {
                        title: "Field Details";
                    }

                    Rectangle {
                        height: 1px;
                        background: #dee2e6;
                    }

                    ScrollView {
                        VerticalLayout {
                            padding: 16px;
                            spacing: 12px;
                            alignment: start;

                            // Field Name
                            FormField {
                                label: "Name";
                                required: true;
                                error-message: (EntitiesTabState.selected_field_id >= 0 && EntitiesTabState.selected_field_name == "") ? "Field name is required" : (CommonTools.check_is_snake_case(EntitiesTabState.selected_field_name) ? "" : "Field name must be in snake_case");

                                StyledLineEdit {
                                    text <=> EntitiesTabState.selected_field_name;
                                    placeholder: "Enter field name (e.g., first_name)";
                                    has-error: (EntitiesTabState.selected_field_id >= 0 && EntitiesTabState.selected_field_name == "") || !CommonTools.check_is_pascal_case(EntitiesTabState.selected_field_enum_name);
                                    edited(text) => {
                                        EntitiesTabState.field_name_changed(text);
                                    }
                                }
                            }

                            // Field Type
                            FormField {
                                label: "Type";
                                required: true;

                                ComboBox {
                                    model: EntitiesTabState.field_type_options;
                                    current-value <=> EntitiesTabState.selected_field_type;
                                    selected(value) => {
                                        EntitiesTabState.field_type_changed(value);
                                    }
                                }
                            }

                            // Referenced Entity (only visible when type is Entity)
                            if EntitiesTabState.selected_field_type == "Entity": FormField {
                                label: "Referenced Entity";

                                entity-combo := ComboBox {
                                    model: EntitiesTabState.entity_options;
                                    current-index <=> EntitiesTabState.selected_field_entity_index;
                                    selected(value) => {
                                        // Pass the selected index to the callback
                                        EntitiesTabState.field_entity_changed(entity-combo.current-index);
                                    }
                                }
                            }

                            // Enum Name (only visible when type is Enum)
                            if EntitiesTabState.selected_field_type == "Enum": FormField {
                                label: "Enum Name";
                                error-message: EntitiesTabState.selected_field_enum_name == "" ? "Entity name is required" : (CommonTools.check_is_pascal_case(EntitiesTabState.selected_field_enum_name) ? "" : "Enum name must be in PascalCase");

                                StyledLineEdit {
                                    text <=> EntitiesTabState.selected_field_enum_name;
                                    placeholder: "Enter enum name";
                                    has-error: EntitiesTabState.selected_field_enum_name == "" || !CommonTools.check_is_pascal_case(EntitiesTabState.selected_field_enum_name);
                                    edited(text) => {
                                        EntitiesTabState.field_enum_name_changed(text);
                                    }
                                }
                            }

                            // Enum Values (only visible when type is Enum)
                            if EntitiesTabState.selected_field_type == "Enum": FormField {
                                label: "Enum Values (one per line in PascalCase)";

                                TextEdit {
                                    height: 100px;
                                    text <=> EntitiesTabState.selected_field_enum_values;
                                    edited(text) => {
                                        EntitiesTabState.field_enum_values_changed(text);
                                    }
                                }
                            }

                            // Required checkbox (only visible when relationship is one_to_one or many_to_one or type is NOT Entity)
                            if EntitiesTabState.selected_field_relationship == "one_to_one" || EntitiesTabState.selected_field_relationship == "many_to_one" || EntitiesTabState.selected_field_type != "Entity": CheckBox {
                                text: "Optional";
                                checked <=> EntitiesTabState.selected_field_optional;
                                toggled => {
                                    EntitiesTabState.field_optional_changed(self.checked);
                                }
                            }

                            // Entity-specific options (only visible when type is Entity)
                            if EntitiesTabState.selected_field_type == "Entity": VerticalLayout {
                                spacing: 12px;
                                FormField {
                                    label: "Relationship Type";
                                    relationship-combo := ComboBox {
                                        model: EntitiesTabState.relationship_type_options;
                                        current-value <=> EntitiesTabState.selected_field_relationship;
                                        selected(value) => {
                                            EntitiesTabState.field_relationship_changed(value);
                                        }
                                    }
                                }

                            // if one_tomany or many_to_many entity
                            if (EntitiesTabState.selected_field_relationship == "one_to_many" || EntitiesTabState.selected_field_relationship == "ordered_one_to_many" || EntitiesTabState.selected_field_relationship == "many_to_many")
                            && EntitiesTabState.selected_field_type == "Entity":
                              FormField {
                                    label: "Model Options";
                                    HorizontalLayout {
                                        spacing: 16px;
                                        CheckBox {
                                            text: "List Model";
                                            checked <=> EntitiesTabState.selected_field_list_model;
                                            toggled => {
                                                EntitiesTabState.field_list_model_changed(self.checked);
                                            }
                                        }
                                    }
                                }

                                if EntitiesTabState.selected_field_list_model: FormField {
                                    label: "List Model Displayed Field";
                                    StyledLineEdit {
                                        text <=> EntitiesTabState.selected_field_list_model_displayed_field;
                                        placeholder: "Enter displayed field name";
                                        edited(text) => {
                                            EntitiesTabState.field_list_model_displayed_field_changed(text);
                                        }
                                    }
                                }

                                HorizontalLayout {
                                    spacing: 16px;

                                    // Strong checkbox (only visible when relationship is NOT many_to_many or many_to_one)
                                    if EntitiesTabState.selected_field_type == "Entity" && EntitiesTabState.selected_field_relationship != "many_to_many" && EntitiesTabState.selected_field_relationship != "many_to_one": CheckBox {
                                        text: "Strong (cascade delete)";
                                        checked <=> EntitiesTabState.selected_field_strong;
                                        toggled => {
                                            EntitiesTabState.field_strong_changed(self.checked);
                                        }
                                    }
                                }
                            }

                            // Spacer
                            Rectangle {
                                vertical-stretch: 1;
                            }
                        }
                    }
                }
            }
        }
    }
}
