// Global singletons for the Qleany Slint UI
// These allow direct access to callbacks and state from any component and from Rust code

import { ListItem as CRListItem } from "components/checkable_reorderable_list.slint";
export { CRListItem }

// Manifest-related commands (Home tab actions)
export global ManifestCommands {
    callback new_manifest();
    callback open_manifest();
    callback save_manifest();
    callback save_manifest_as();
    callback close_manifest();
    callback open_qleany_manifest();
    callback exit_app();
}

// Undo/Redo commands
export global UndoRedoCommands {
    callback undo();
    callback redo();
}

// Project settings commands
export global ProjectCommands {
    callback save_project_settings();
}

// Feature selection commands  
export global FeatureCommands {
    callback select_feature(int);
    callback select_use_case(int);
}

// Code generation commands
export global GenerateCommands {
    callback list_files();
    callback start_generate();
    callback cancel_generate();
}
export global ProjectTabState {
    in-out property <int> project_undo_stack_id: -1;

    // Project settings properties
    in-out property <string> language: "Rust";
    in-out property <string> application_name: "";
    in-out property <string> organisation_name: "";
    in-out property <string> organisation_domain: "";
    in-out property <string> prefix_path: "";

    // Callbacks for project settings changes
    callback language_changed(string);
    callback application_name_changed(string);
    callback organisation_name_changed(string);
    callback organisation_domain_changed(string);
    callback prefix_path_changed(string);
}

export global EntitiesTabState {
    in-out property <int> entities_undo_stack_id: -1;

    // Entity lists and selection
    in-out property <[CRListItem]> entity_cr_list: [];
    callback request_entities_reorder(int /* from_index */, int /* to_index */);
    in-out property <int> selected_entity_id: -1;
    callback entity_selected(int);
    callback request_entity_deletion(int /* entity_id */);
    callback request_entity_addition();
    // name input :
    in-out property <string> selected_entity_name: "";
    callback entity_name_changed(string);

    // only_for_heritage checkbox
    in-out property <bool> selected_entity_only_for_heritage: false;
    callback entity_only_for_heritage_changed(bool);

    // inherits_from combo box
    in-out property <int> selected_entity_inherits_from: -1;  // -1 means "None"
    in-out property <string> selected_entity_inherits_from_value: "None";  // The actual value for current-value binding
    in-out property <[string]> inherits_from_options: ["None"];  // "None" + entity names
    in-out property <[int]> inherits_from_option_ids: [-1];  // -1 for "None" + entity ids
    callback entity_inherits_from_changed(int);  // receives the index in the combo box

    // Other entity details properties
    in-out property <bool> selected_entity_single_model: true;
    callback entity_single_model_changed(bool);
    in-out property <bool> selected_entity_undoable: true;
    callback entity_undoable_changed(bool);
    in-out property <bool> selected_entity_allow_direct_access: false;
    callback entity_allow_direct_access_changed(bool);

    // fields
    in-out property <[CRListItem]> field_cr_list: [];
    callback request_fields_reorder(int /* from_index */, int /* to_index */);
    in-out property <int> selected_field_id: -1;
    callback field_selected(int);
    callback request_field_deletion(int /* field_id */);
    callback request_field_addition();

    // Field details properties
    in-out property <string> selected_field_name: "";
    in-out property <string> selected_field_type: "String";
    in-out property <int> selected_field_entity: -1;
    in-out property <string> selected_field_relationship: "one_to_one";
    in-out property <bool> selected_field_required: false;
    in-out property <bool> selected_field_strong: true;
    in-out property <bool> selected_field_list_model: false;
    in-out property <string> selected_field_list_model_displayed_field: "";
    in-out property <string> selected_field_enum_name: "";
    in-out property <string> selected_field_enum_values: "";

    // Field type options for ComboBox
    in-out property <[string]> field_type_options: ["Boolean", "Integer", "UInteger", "Float", "String", "Uuid", "DateTime", "Entity", "Enum"];
    // Relationship type options for ComboBox (only for Entity type fields)
    in-out property <[string]> relationship_type_options: ["one_to_one", "one_to_many", "ordered_one_to_many", "many_to_many"];
    // Entity options for referenced entity ComboBox (populated dynamically)
    in-out property <[string]> entity_options: [];
    in-out property <[int]> entity_option_ids: [];

    // Field details callbacks
    callback field_name_changed(string);
    callback field_type_changed(string);
    callback field_entity_changed(int);
    callback field_is_primary_key_changed(bool);
    callback field_relationship_changed(string);
    callback field_required_changed(bool);
    callback field_strong_changed(bool);
    callback field_list_model_changed(bool);
    callback field_list_model_displayed_field_changed(string);
    callback field_enum_name_changed(string);
    callback field_enum_values_changed(string);
}

export global FeaturesTabState {
    in-out property <int> features_undo_stack_id: -1;

    // Loading and error states
    in-out property <bool> features_is_loading: false;
    in-out property <string> features_error_message: "";

    // Feature lists and selection
    in-out property <[CRListItem]> feature_cr_list: [];
    callback request_features_reorder(int /* from_index */, int /* to_index */);
    in-out property <int> selected_feature_id: -1;
    callback feature_selected(int);
    callback request_feature_deletion(int /* feature_id */);
    callback request_feature_addition();

    // Feature details
    in-out property <string> selected_feature_name: "";
    callback feature_name_changed(string);

    // Use case lists and selection
    in-out property <[CRListItem]> use_case_cr_list: [];
    callback request_use_cases_reorder(int /* from_index */, int /* to_index */);
    in-out property <int> selected_use_case_id: -1;
    callback use_case_selected(int);
    callback request_use_case_deletion(int /* use_case_id */);
    callback request_use_case_addition();

    // Use case details properties
    in-out property <string> selected_use_case_name: "";
    in-out property <bool> selected_use_case_validator: false;
    in-out property <bool> selected_use_case_undoable: false;
    in-out property <bool> selected_use_case_read_only: false;
    in-out property <bool> selected_use_case_long_operation: false;

    // Use case details callbacks
    callback use_case_name_changed(string);
    callback use_case_validator_changed(bool);
    callback use_case_undoable_changed(bool);
    callback use_case_read_only_changed(bool);
    callback use_case_long_operation_changed(bool);

    // DTO field type options for ComboBox
    in-out property <[string]> dto_field_type_options: ["Boolean", "Integer", "UInteger", "Float", "String", "Uuid", "DateTime", "Enum"];

    // DTO In enabled state (DTOs are optional)
    in-out property <bool> dto_in_enabled: false;
    callback dto_in_enabled_changed(bool);

    // DTO Out enabled state (DTOs are optional)
    in-out property <bool> dto_out_enabled: false;
    callback dto_out_enabled_changed(bool);

    // DTO In properties
    in-out property <int> selected_dto_in_id: -1;
    in-out property <string> selected_dto_in_name: "";
    callback dto_in_name_changed(string);

    // DTO In fields list and selection
    in-out property <[CRListItem]> dto_in_field_cr_list: [];
    callback request_dto_in_fields_reorder(int /* from_index */, int /* to_index */);
    in-out property <int> selected_dto_in_field_id: -1;
    callback dto_in_field_selected(int);
    callback request_dto_in_field_deletion(int /* dto_in_field_id */);
    callback request_dto_in_field_addition();

    // DTO In field details properties
    in-out property <string> selected_dto_in_field_name: "";
    in-out property <int> selected_dto_in_field_type_index: 4; // Default to String
    in-out property <bool> selected_dto_in_field_is_nullable: false;
    in-out property <bool> selected_dto_in_field_is_list: false;

    // DTO In field details callbacks
    callback dto_in_field_name_changed(string);
    callback dto_in_field_type_changed(string);
    callback dto_in_field_is_nullable_changed(bool);
    callback dto_in_field_is_list_changed(bool);

    // DTO Out properties
    in-out property <int> selected_dto_out_id: -1;
    in-out property <string> selected_dto_out_name: "";
    callback dto_out_name_changed(string);

    // DTO Out fields list and selection
    in-out property <[CRListItem]> dto_out_field_cr_list: [];
    callback request_dto_out_fields_reorder(int /* from_index */, int /* to_index */);
    in-out property <int> selected_dto_out_field_id: -1;
    callback dto_out_field_selected(int);
    callback request_dto_out_field_deletion(int /* dto_out_field_id */);
    callback request_dto_out_field_addition();

    // DTO Out field details properties
    in-out property <string> selected_dto_out_field_name: "";
    in-out property <int> selected_dto_out_field_type_index: 4; // Default to String
    in-out property <bool> selected_dto_out_field_is_nullable: false;
    in-out property <bool> selected_dto_out_field_is_list: false;

    // DTO Out field details callbacks
    callback dto_out_field_name_changed(string);
    callback dto_out_field_type_changed(string);
    callback dto_out_field_is_nullable_changed(bool);
    callback dto_out_field_is_list_changed(bool);

    // Use case entities list (checkable list of all entities, checked = associated with use case)
    in-out property <[CRListItem]> use_case_entity_cr_list: [];
    callback use_case_entity_check_changed(int /* entity_id */, bool /* checked */);
}

// Application-wide state
export global AppState {
    in-out property <int> workspace_id: -1;
    // system_id is always 1
    in-out property <int> system_id: 1;
    in-out property <bool> force_exit: false;
    // Manifest save state
    in-out property <bool> manifest_is_saved: true;
    // Manifest is open state
    in-out property <bool> manifest_is_open: false;
    // Manifest path
    in-out property <string> manifest_path: "";

    // Confirmation dialog state
    // pending_action values: "none", "new", "open", "close", "exit", "open_qleany"
    in-out property <bool> confirm_dialog_visible: false;
    in-out property <string> confirm_dialog_message: "";
    in-out property <string> confirm_dialog_pending_action: "none";
    callback confirm_dialog_accepted();
    callback confirm_dialog_rejected();

    // Loading and error states
    in-out property <bool> is_loading: false;
    in-out property <string> error_message: "";
    
    // Success notifications
    in-out property <string> success_message: "";
    in-out property <bool> success_message_visible: false;
    
    // Navigation
    in-out property <int> current_tab: 0;
    
    // Undo/Redo state
    in-out property <bool> can_undo: false;
    in-out property <bool> can_redo: false;
    
    // Generate state
    in-out property <bool> generate_is_running: false;
    in-out property <float> generate_progress: 0;
    in-out property <string> generate_message: "";
    in-out property <bool> generate_in_temp: true;
    in-out property <[string]> group_list: [];
    in-out property <[string]> file_list: [];
    in-out property <[CRListItem]> group_cr_list: [];
    in-out property <[CRListItem]> file_cr_list: [];
    in-out property <int> selected_group_index: -1;
    in-out property <string> selected_group_name: "";
    in-out property <int> selected_file_index: -1;
    in-out property <string> selected_file_name: "";
    in-out property <string> code_preview: "";
    // File filter text input
    in-out property <string> file_filter_text: "";
    // Number of selected (checked) files
    in-out property <int> selected_files_count: 0;
    // Pre-computed text parts for bold filename display
    in-out property <[string]> file_text_prefixes: [];
    in-out property <[string]> file_text_bolds: [];
    // Pre-computed elided texts for long file names (left elide)
    in-out property <[string]> file_elided_texts: [];
    // Pre-computed elided text parts for bold display (when bold-after-slash is true)
    in-out property <[string]> file_elided_prefixes: [];
    in-out property <[string]> file_elided_bolds: [];

    // Generate tab callbacks
    callback group_selected(int);
    callback file_selected(int);
    callback refresh_generate_tab();
    // File filter callback
    callback file_filter_changed(string);
    // Group check change callback (for exclusive selection behavior)
    callback group_check_changed(int, bool);
    // File check change callback (for updating selected files count)
    callback file_check_changed(int, bool);
    // Select/Unselect all files
    callback select_all_files();
    callback unselect_all_files();
}

export global UserInterfaceTabState {
    in-out property <int> user_interface_undo_stack_id: -1;

    // UserInterface entity fields
    in-out property <bool> rust_cli: false;
    in-out property <bool> rust_slint: false;
    in-out property <bool> cpp_qt_qtwidgets: false;
    in-out property <bool> cpp_qt_qtquick: false;
    in-out property <bool> cpp_qt_kirigami: false;

    // Callbacks for field changes
    callback rust_cli_changed(bool);
    callback rust_slint_changed(bool);
    callback cpp_qt_qtwidgets_changed(bool);
    callback cpp_qt_qtquick_changed(bool);
    callback cpp_qt_kirigami_changed(bool);
}
